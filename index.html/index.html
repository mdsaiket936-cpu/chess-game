<!-- Firebase (module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // тЬЕ ржЖржкржирж╛рж░ Firebase config ржПржЦрж╛ржирзЗ ржмрж╕рж╛ржи
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Firestore document ref
  const stateRef = doc(db, "election", "state");

  // ---------- UI ржерзЗржХрзЗ state apply ----------
  function applyStateToUI(state) {
    const bnp = state.bnp ?? 0;
    const jamaat = state.jamaat ?? 0;
    const japa = state.japa ?? 0;
    const ncp = state.ncp ?? 0;
    const otherParty = state.otherParty ?? 0;
    const other = state.other ?? 0;

    // Display
    document.getElementById('bnpDisplay').innerText = bnp;
    document.getElementById('jamaatDisplay').innerText = jamaat;
    document.getElementById('japaDisplay').innerText = japa;
    document.getElementById('ncpDisplay').innerText = ncp;
    document.getElementById('otherPartyDisplay').innerText = otherParty;
    document.getElementById('otherDisplay').innerText = other;

    // Admin current badges
    const bnpC = document.getElementById('bnpCurrent');
    if (bnpC) bnpC.innerText = bnp;
    const jamaatC = document.getElementById('jamaatCurrent');
    if (jamaatC) jamaatC.innerText = jamaat;
    const japaC = document.getElementById('japaCurrent');
    if (japaC) japaC.innerText = japa;
    const ncpC = document.getElementById('ncpCurrent');
    if (ncpC) ncpC.innerText = ncp;
    const otherPartyC = document.getElementById('otherPartyCurrent');
    if (otherPartyC) otherPartyC.innerText = otherParty;
    const otherC = document.getElementById('otherCurrent');
    if (otherC) otherC.innerText = other;

    // remaining/total
    const total = bnp + jamaat + japa + ncp + otherParty + other;
    document.getElementById('zeroLeft').innerText = total;
    document.getElementById('remainingDisplay').innerText = 300 - total;

    // last update
    if (state.lastUpdate) document.getElementById('updateTimeText').innerText = state.lastUpdate;

    // notification badge
    const badge = document.getElementById('updateBadge');
    badge.style.display = 'inline-block';
    setTimeout(() => (badge.style.display = 'none'), 2500);
  }

  // ---------- ЁЯФ┤ LIVE: рж╕ржм ржЗржЙржЬрж╛рж░ ржПржЦрж╛ржирзЗ рж╢рзБржиржмрзЗ ----------
  onSnapshot(stateRef, (snap) => {
    if (snap.exists()) {
      applyStateToUI(snap.data());
    }
  });

  // ---------- Admin update function (Firestore ржП рж▓рж┐ржЦржмрзЗ) ----------
  async function updateParty(partyKey, value) {
    const num = Math.max(0, Math.min(300, parseInt(value || "0", 10)));
    const nowText = new Date().toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

    // partial update
    await setDoc(stateRef, {
      [partyKey]: num,
      lastUpdate: nowText,
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  // ---------- ржЖржкржирж╛рж░ existing onclick ржлрж╛ржВрж╢ржиржЧрзБрж▓рзЛржХрзЗ bind ржХрж░рзБржи ----------
  window.updateBNP = () => updateParty("bnp", document.getElementById("bnpInput").value);
  window.updateJamaat = () => updateParty("jamaat", document.getElementById("jamaatInput").value);
  window.updateJapa = () => updateParty("japa", document.getElementById("japaInput").value);
  window.updateNCP = () => updateParty("ncp", document.getElementById("ncpInput").value);
  window.updateOtherParty = () => updateParty("otherParty", document.getElementById("otherPartyInput").value);
  window.updateOther = () => updateParty("other", document.getElementById("otherInput").value);

  // тЬЕ ржЖржкржирж╛рж░ ржкрзБрж░рзЛржирзЛ localStorage broadcastUpdate/processUpdate listener ржЖрж░ рж▓рж╛ржЧржмрзЗ ржирж╛
</script>
